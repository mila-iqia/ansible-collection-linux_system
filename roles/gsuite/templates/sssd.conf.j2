{% if 'ipaclients' in group_names %}
[sssd]
services = nss, pam, ssh, sudo
domains = {{ gsuite_mila_domain }}

[nss]
homedir_substring = /home

[domain/{{ gsuite_mila_domain }}]
id_provider = ipa
dns_discovery_domain = {{ gsuite_mila_domain }}
ipa_server = _srv_, {{ gsuite_ipamaster }}, {{ gsuite_ipareplica }}
ipa_domain = {{ gsuite_mila_domain }}
ipa_hostname = {{ inventory_hostname }}.{{ gsuite_ipa_servers_domain }}
auth_provider = ipa
chpass_provider = ipa
access_provider = ipa
cache_credentials = True
ldap_tls_cacert = /etc/ipa/ca.crt
krb5_store_password_if_offline = True

{% else %}
[sssd]
services = nss, pam
domains = {{ gsuite_mila_domain }}

[domain/{{ gsuite_mila_domain }}]
ldap_tls_cert = /etc/sssd/certs/{{ gsuite_cert_name }}.crt
ldap_tls_key = /etc/sssd/certs/{{ gsuite_cert_name }}.key
ldap_uri = {{ gsuite_ldap_uri }}
ldap_search_base = {{ gsuite_search_base }}
ldap_user_search_base = {{ gsuite_user_search_base }}
ldap_group_search_base = {{ gsuite_group_search_base }}
id_provider = ldap
auth_provider = ldap
ldap_schema = rfc2307bis
ldap_user_name = posixUid
ldap_user_uuid = entryUUID
ldap_user_gecos = googleUid

{% if ansible_facts['distribution_release'] == 'focal' %}
# GEN-977 - Google LDAP is not compatible with TLS 1.3 in Ubuntu 20.04
ldap_tls_cipher_suite = NORMAL:!VERS-TLS1.3
{% endif %}

{% if gsuite_override_homedir is defined %}
# Set default Home
override_homedir = {{ gsuite_override_homedir }}
{% endif %}
{% endif %}

# Access control
access_provider = simple
simple_allow_groups = {{ gsuite_authorized_groups }}

# Allow same UID/GID
auto_private_groups = true

# No cache cleaning
ldap_purge_cache_timeout = 0

# Do not download full list for getent group
ignore_group_members = true

{% if gsuite_sssd_enumerate is defined %}
enumerate = {{ gsuite_sssd_enumerate }}
{% endif%}
